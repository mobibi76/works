<!doctype html>
<html lang="ko">
    <head>
        <title>Î¶¨Ïä§ÌÅ¨ Ïï†ÏûêÏùº ÌîÑÎ°úÏÑ∏Ïä§ Î∞è ÌåÄ ÎÑ§Ìä∏ÏõåÌÅ¨ ÎîîÏûêÏù∏ | Process Design and People Define Based Ops. </title>

        <!--SEO, mobile ops. and encoding-->
        <meta name="description"
            content="ÏãúÏä§ÌÖú Îã§Ïù¥ÎÇ¥ÎØπÏä§ ÌôúÏö© Î¶¨Ïä§ÌÅ¨ Ïï†ÏûêÏùº ÌîÑÎ°úÏÑ∏Ïä§ Î∞è Ïä§ÌÇ¨ Ï†ïÏùò Í∏∞Î∞ò ÌåÄ ÎÑ§Ìä∏ÏõåÌÅ¨ ÎîîÏûêÏù∏">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="utf-8">

        <!--content security policy (CSP) with nonce-->
        <meta http-equiv="Content-Security-Policy"
            content="default-src 'self';
                    script-src 'self' https://ajax.googleapis.com 'nonce-abc123';
                    style-src 'self' 'unsafe-inline';
                    img-src 'self';
                    font-src 'self';
                    frame-ancestors 'none';
                    base-uri 'self';
                    connect-src 'self';">

        <!--referrer policy-->
        <meta name="referrer" content="no-referrer">

        <!--jQuery google CDN with SRI-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha384-1H217gwSVyLSIfaLxHbE7dRb3v4mYCKbpQvzx0cegeju1MVsGrX5xXxAvs/HgeFs"
            crossorigin="anonymous" async></script>

        <!--style.css-->
        <link rel="stylesheet" href="./style/style.css">

        <!--fetch.js-->
        <script src="./source/fetch.js"></script>
    </head>

    <body>
        <header>
            <h2>process design-based ops.</h2>
        </header>

        <article id="flex">
            <nav id="nav"></nav>
            <main id="container"></main>
            <canvas id="aniCanvas"></canvas>
        </article>

        <!--popup-->
        <div id="popup" class="popup-overlay">
            <div class="popup-content">
                <a href="https://blog.naver.com/totoriverce" target="_blank">
                    <img src="./notice/popup.png" alt="popup_content">
                </a>
                <p>üõ°Ô∏èÏ†ïÎ≥¥Î≥¥Ìò∏ Í¥ÄÎ¶¨Ï≤¥Í≥Ñ Ï†ÑÎ¨∏Í∞Ä Î∏îÎ°úÍ∑∏üõ°Ô∏è</p>
                <label>
                    <input type="checkbox" id="donot-show-again">Ïò§Îäò ÌïòÎ£® ÎèôÏïà Ïó¥ÏßÄ ÏïäÏùå
                </label>
                <button id="close-popup">ÌôïÏù∏</button>
            </div>
        </div>

        <script nonce="abc123">
        /*--A. click event to all inter-link class--*/
            function bindInterLinkEvent() {
                    const interLinks = document.querySelectorAll('.inter-link');
                    interLinks.forEach(link => {
                        link.addEventListener('click', function(event) {
                            event.preventDefault();
                            const pageTitle = this.getAttribute('href').substring(2);
                            introFetch(pageTitle);
                        });
                    });
                }

        /*--B. fetch.js control--*/
            // B1. define introFetch function
            function introFetch(pageTitle) {
                fetch(pageTitle).then(response => {

                    if (!response.ok) {
                        throw new Error('Network Not Good');
                    }
                    return response.text();
                }).then(text => {
                    const containerElement = document.querySelector('#container');

                    if (containerElement) {
                        containerElement.innerHTML = text;
                        containerElement.scrollTop = 0;
                        bindInterLinkEvent(); // add inter-link class for CSP
                    }
                }).catch(error => {
                    console.error('Fetch Operation Not Good:', error);
                });
            }

            // B2. load pages through fetch.js with error handle
            function fetchPageContent(pageTitle, targetElementSelector) {
                return fetch(pageTitle).then(response => {

                    if (!response.ok) {
                        throw new Error('Network Not Good');
                    }
                    return response.text();
                }).then(text => {
                    const targetElement = document.querySelector(targetElementSelector);

                    if (targetElement) {
                        targetElement.innerHTML = text;
                        targetElement.scrollTop = 0;

                        if (targetElementSelector === '#container') { // add inter-link class for CSP
                           bindInterLinkEvent();
                        }
                    }
                }).catch(error => {
                    console.error('Fetch Operation Not Good:', error);
                });
            }

        /*--C. calculate header-flex to fix scroll issue on container--*/
            function adjustContainerHeight() {                
                const headers = document.querySelectorAll('header h1, header h2');
                let headerHeight = 0;                    
                headers.forEach(header => {
                    headerHeight += header.getBoundingClientRect().height;
                });                    
                const windowHeight = window.innerHeight;
                const flexHeight = windowHeight - headerHeight;
                document.querySelector('#flex').style.height = `${flexHeight}px`;
                const navElement = document.querySelector('#nav');
                    
                if (navElement) {
                    navElement.style.height = 'auto';
                    const navHeight = navElement.scrollHeight;
                    navElement.style.height = `${navHeight}px`;
                }                    
                const containerHeight = flexHeight - navElement.offsetHeight;
                document.querySelector('#container').style.height = `${containerHeight}px`;
            }

        /*--D. tooltip display for table(tr, td) and image--*/
            function tooltipEventHandle() {
                const tooltip = document.createElement('div');
                tooltip.id = 'tooltip';

                // D1. mouse event for pc
                document.body.appendChild(tooltip);
                document.addEventListener('mouseover', function (e) {
                    const target = e.target.closest('td[data-tooltip], tr[data-tooltip], img[data-tooltip]');

                    if (target) {
                        const text = target.getAttribute('data-tooltip') || '';
                        tooltip.textContent = text;
                        tooltip.classList.remove('tooltip-text', 'tooltip-image');

                        if (target.tagName.toLowerCase() === 'img') {
                            tooltip.classList.add('tooltip-image');
                        } else {
                            tooltip.classList.add('tooltip-text');
                        }
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    }
                });
                document.addEventListener('mousemove', function (e) {

                    if (tooltip.style.display === 'block') {
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    }
                });
                document.addEventListener('mouseout', function (e) {
                    const target = e.target.closest('td[data-tooltip], tr[data-tooltip], img[data-tooltip]');

                    if (!target) {
                        tooltip.style.display = 'none';
                    }
                });

                // D2. touch event for mobile
                document.addEventListener('touchstart', function (e) {
                    const touch = e.touches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY).closest('td[data-tooltip], tr[data-tooltip], img[data-tooltip]');

                    if (target) {
                        const text = target.getAttribute('data-tooltip') || '';
                        tooltip.textContent = text;
                        tooltip.classList.remove('tooltip-text', 'tooltip-image');

                        if (target.tagName.toLowerCase() === 'img') {
                            tooltip.classList.add('tooltip-image');
                        } else {
                            tooltip.classList.add('tooltip-text');
                        }                            
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${touch.pageX + 10}px`;
                        tooltip.style.top = `${touch.pageY + 10}px`;
                    }
                });
                document.addEventListener('touchmove', function (e) {
                    const touch = e.touches[0];
                    tooltip.style.left = `${touch.pageX + 10}px`;
                    tooltip.style.top = `${touch.pageY + 10}px`;
                });
                document.addEventListener('touchend', function () {
                    tooltip.style.display = 'none';
                });
            }

        /*--E. popup--*/
            function openPopup() {
                const donotShowAgain = localStorage.getItem('donotShowPopup');

                if (!donotShowAgain) {
                    document.getElementById('popup').style.display = 'flex';
                }
            }
                document.getElementById('close-popup').addEventListener('click', function() {
                    const donotShowAgainCheckbox = document.getElementById('donot-show-again');

                    if (donotShowAgainCheckbox.checked) {
                        localStorage.setItem('donotShowPopup', 'true');
                    }
                    document.getElementById('popup').style.display = 'none';
                });

        /*--F. autoplay the video identified--*/
            function videoPlay() {
                window.onload = function() {
                    var video = document.getElementById("pdbopsVideo");

                    if (video) { // fix play video with canvas animation
                        video.loading = "lazy";
                        video.onloadeddata = function() {
                            video.play().then(function() {
                                console.log("Video Play Good");
                                startCanvasAnimation();
                            }).catch(function(error) {
                                console.log("Video Play Not Good:", error);
                                startCanvasAnimation();                                
                            });
                        };
                        video.onerror = function() {          
                            console.warn("Video Load Not Good");
                            startCanvasAnimation();
                        };
                    } else {
                        console.warn("Video Element Load Not Good");
                        startCanvasAnimation();
                    }
                }
            }

        /*--G. canvas animation--*/
            let animationFrameID;

            function startCanvasAnimation() {
                var canvas = document.getElementById("aniCanvas");

                if (canvas) {
                    resizeCanvasAnimation(canvas);
                    var obj = canvas.getContext('2d');
                    var objAction = [];

                    for (var i = 0; i <100; i++) {
                        objAction.push ({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height,
                            length: Math.random() * 20 + 10,
                            velocity: Math.random() * 5 + 2
                        });
                    }

                    function drawObject() {
                        obj.clearRect(0, 0, canvas.width, canvas.height);
                        obj.strokeStyle = 'rgba(175, 195, 225, 0.5)';
                        obj.lineWidth = 1;

                        for (var i = 0; i < objAction.length; i++) {
                            var action = objAction[i];
                            obj.beginPath();
                            obj.moveTo(action.x, action.y);
                            obj.lineTo(action.x, action.y + action.length);
                            obj.stroke();
                            action.y += action.velocity;

                            if (action.y > canvas.height) {
                                action.y = -action.length;
                            }
                        }
                        animationFrameID = requestAnimationFrame(drawObject);
                    }
                    drawObject();
                    console.log("Canvas Animation Good");
                    window.addEventListener('resize', function() {
                        resizeCanvasAnimation(canvas);
                    });
                } else {
                    console.error("Canvas Load Not Good");
                }
            }

        /*--H. canvas animation resize--*/
            function resizeCanvasAnimation(canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                console.log(`Canvas Resized: ${canvas.width} x ${canvas.height}`);
            }

        /*--Main : page load--*/
            document.addEventListener("DOMContentLoaded", function() {
                // DOM Content Loaded control and adjust heithts
                Promise.all([
                    fetchPageContent('Menu', '#nav'),
                    fetchPageContent('Cover', '#container')
                ]).then(() => {
                    adjustContainerHeight();
                    resizeCanvasAnimation(document.getElementById("aniCanvas"));
                    window.addEventListener('resize', function() {
                        adjustContainerHeight();
                        resizeCanvasAnimation(document.getElementById("aniCanvas"));
                    });
                    // inter-link class for CSP
                    bindInterLinkEvent();
                    // tooltip
                    tooltipEventHandle();
                    // popup
                    openPopup();
                    // video
                    videoPlay()
                });
            });

        /*--Sub : canvas animation cancle at page unload--*/
            window.addEventListener("beforeunload", function() {
                cancelAnimationFrame(animationFrameID);
            });
        </script>
    </body>
</html>